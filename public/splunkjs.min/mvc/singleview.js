define("views/shared/SingleValue",["jquery","underscore","module","views/Base","splunk.util","uri/route"],function(e,t,n,r,i,s){var o=function(e,n){if(t.isFunction(e))try{e=e(n)}catch(r){return""}return e};return r.extend({moduleId:n.id,className:"single-value",initialize:function(e){r.prototype.initialize.apply(this,arguments),this.activate()},events:{"click a.single-drilldown":function(n){n.preventDefault();var r=e(n.currentTarget),i=this.model.searchResultsColumn,s=t.object(t(i.get("fields")).map(function(e){return"row."+e}),t(i.get("columns")).pluck(0)),o={modifierKey:!!n.ctrlKey||!!n.metaKey,name:r.data("field"),value:r.data("value"),rowContext:s},u=t(r.children("span").attr("class").split(" ")).map(function(e){return"click:"+e}).join(" ");this.trigger("click "+u,o)}},startListening:function(){this.listenTo(this.model.state,"change:display.visualizations.singlevalue.beforeLabel change:display.visualizations.singlevalue.afterLabel change:display.visualizations.singlevalue.underLabel change:display.visualizations.singlevalue.additionalClass",this.render),this.listenTo(this.model.searchResultsColumn,"change",this.render)},getResultField:function(e){return this.getFieldValue(this.determineResultFieldName(e))},getFieldNames:function(){var n=this.model.searchResultsColumn.get("fields");return!n||n.length===0?[]:t.isObject(n[0])?t(n).pluck("name"):e.extend([],n)},setSeverity:function(){if(this.model.searchResultsColumn.get("fields")){var e=t(this.model.searchResultsColumn.get("fields")).pluck("name"),n=e.indexOf("range");n>-1&&this.$("span.single-result").addClass(this.model.searchResultsColumn.get("columns")[n][0])}},determineResultFieldName:function(e){var n=this.getFieldNames();return e&&t(n).contains(e)?e:t(n).find(function(e){return e==="_time"||e==="_raw"||e[0]!=="_"})},getFieldValue:function(e,n){var r=this.getFieldNames(),i=t(r).indexOf(e),s=this.model.searchResultsColumn.get("columns")||[],o=s[i];return!o||!o.length?n:o[0]},render:function(){this._originalClass||(this._originalClass=this.$el.attr("class"));var e=this.determineResultFieldName(this.model.state.get("display.visualizations.singlevalue.field")),n=this.getFieldValue(e,t("N/A").t()),r=this.compiledTemplate({result:n,beforeLabel:o(this.model.state.get("display.visualizations.singlevalue.beforeLabel")||"",n),afterLabel:o(this.model.state.get("display.visualizations.singlevalue.afterLabel")||"",n),underLabel:o(this.model.state.get("display.visualizations.singlevalue.underLabel")||"",n)}),i=[this._originalClass,this.model.state.get("display.visualizations.singlevalue.additionalClass"),this.getResultField(this.model.state.get("display.visualizations.singlevalue.classField"))];return this.$el.attr("class",i.join(" ")),this.$el.html(r),this.wrapLinks(e,n),this.setSeverity(),this},wrapLinks:function(n,r){if(!this.model.application)return;var o=this.model.state.get("display.visualizations.singlevalue.linkFields");o=o?e.trim(o).split(/\s*,\s*/):[];var u=this.model.state.get("display.visualizations.singlevalue.linkView"),a=this.model.state.get("display.visualizations.singlevalue.linkSearch"),f=this.model.state.get("display.visualizations.singlevalue.drilldown")||"none",l=this.model.application.toJSON(),c={beforelabel:".before-label",afterlabel:".after-label",underlabel:".under-label",result:".single-result"},h;if(u!=="search"&&o.length||a){var p;if(u){var d=a?{q:a}:undefined;u.charAt(0)==="/"?p=i.make_full_url(u,d):p=s.page(l.root,l.locale,l.app,u,{data:d})}else p=s.search(l.root,l.locale,l.app,{data:{q:a}});h=e("<a />").attr("href",p)}else f!=="none"&&(h=e('<a class="single-drilldown" href="#"></a>'),t(o).contains("result")||o.push("result"));if(h){h.data({field:n,value:r});var v=this.$el;t(o).each(function(e){var t=c[e];t&&v.children(t).wrap(h)})}},template:'                <span class="before-label">                    <%- beforeLabel %>                </span>                <span class="single-result">                    <%- result %>                </span>                <span class="after-label">                    <%- afterLabel %>                </span>                <br>                <span class="under-label">                    <%- underLabel %>                </span>            '})}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("splunkjs/css/single-value.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,define("splunkjs/mvc/singleview",["require","exports","module","underscore","jquery","./mvc","./basesplunkview","views/shared/SingleValue","backbone","./utils","./messages","./tokenawaremodel","./sharedmodels","./drilldown","css!../css/single-value"],function(e,t,n){var r=e("underscore"),i=e("jquery"),s=e("./mvc"),o=e("./basesplunkview"),u=e("views/shared/SingleValue"),a=e("backbone"),f=e("./utils"),l=e("./messages"),c=e("./tokenawaremodel"),h=e("./sharedmodels"),p=e("./drilldown");e("css!../css/single-value");var d=o.extend({moduleId:n.id,className:"splunk-single",options:{data:"preview",beforeLabel:"",afterLabel:"",field:"",classField:"",linkView:"search",drilldownRedirect:!0},omitFromSettings:["el","reportModel"],initialize:function(){this.configure(),this.model=this.options.reportModel||c._createReportModel(),this.settings._sync=f.syncModels(this.settings,this.model,{auto:!0,prefix:"display.visualizations.singlevalue.",include:["additionalClass","linkView","field","linkFields","classField","beforeLabel","afterLabel","underLabel","linkSearch","drilldown"]}),this.settings.set("drilldown",p.getNormalizedDrilldownType(this.settings.get("drilldown"),{"default":"none"})),this.results=new a.Model({columns:[],fields:[]}),this.reportModel=c._createReportModel(),this.reportModel._sync=f.syncModels(this.model,this.reportModel,{auto:"push",tokens:!0}),this.singleValue=new u({model:{searchResultsColumn:this.results,state:this.reportModel,application:h.get("app")}}),this.listenTo(this.singleValue,"click",this.emitDrilldownEvent),this.bindToComponentSetting("managerid",this._onManagerChange,this),this.settings.on("change",this.render,this),this.manager||this._onManagerChange(s.Components,null)},emitDrilldownEvent:function(e){var t=this.manager,n=p.createEventPayload({field:e.name2||e.name,data:p.normalizeDrilldownEventData(e,{contextProperty:"rowContext",manager:t}),event:e},function(){p.autoDrilldown(e,t,{sync:e.modifierKey})});this.trigger("drilldown click",n,this),this.settings.get("drilldownRedirect")&&!n.defaultPrevented()&&n.drilldown()},_onManagerChange:function(e,t){this.manager&&(this.manager.off(null,null,this),this.manager=null),this.resultsModel&&(this.resultsModel.off(null,null,this),this.resultsModel=null),this._searchStatus=null,this._clearResults();if(!t){this._searchStatus={state:"nomanager"},this.render();return}this._searchStatus={state:"start"},this.manager=t,t.on("search:start search:progress",this.onSearchProgress,this),t.on("search:done",this.onSearchDone,this),t.on("search:error",this.onSearchError,this),t.on("search:fail",this.onSearchFailed,this),this.resultsModel=this.manager.data(this.settings.get("data"),{output_mode:"json_cols",count:1,offset:0,show_empty_fields:"True"}),this.resultsModel.on("data",this._onDataUpdate,this),this.resultsModel.on("error",this.onSearchError,this);var n=t.replayLastSearchEvent(this);n||this.render()},onSearchProgress:function(e){var t=((e||{}).content||{}).resultPreviewCount||0;this._searchStatus={state:"running",previewCount:t},this.render()},onSearchDone:function(e){var t=((e||{}).content||{}).resultPreviewCount||0;this._searchStatus={state:"done",previewCount:t},this.render()},onSearchError:function(e,t){var n=l.getSearchErrorMessage(t)||e;this._searchStatus={state:"error",message:n},this.render()},onSearchFailed:function(e){var t=l.getSearchFailureMessage(e);this._searchStatus={state:"error",message:t},this.render()},_clearResults:function(){this.results.set({columns:null,fields:null},{unset:!0})},_onDataUpdate:function(){this.resultsModel.hasData()?this.results.set({columns:this.resultsModel.data().columns,fields:this.resultsModel.data().fields}):(this._clearResults(),this._searchStatus&&(this._searchStatus.previewCount=0)),this.render()},render:function(){var e=this._searchStatus||null,t=e&&e.previewCount,n=t&&this.resultsModel&&this.resultsModel.hasData(),r=null;if(e)switch(e.state){case"nomanager":r="no-search";break;case"start":r="empty";break;case"running":t||(r="waiting");break;case"cancelled":r="cancelled";break;case"done":t?n||(r="waiting"):r="no-results";break;case"error":r={level:"error",icon:"warning-sign",message:e.message}}return r?(this.messageElement||(this.messageElement=i('<div class="msg"></div>')),r==="waiting"?this.messageElement.addClass("waiting").html('<div class="single-value"><span class="single-result">&hellip;</span></div>'):r==="no-results"?this.messageElement.addClass("no-results").html('<div class="single-value"><span class="single-result">N/A</span></div>'):l.render(r,this.messageElement.removeClass("waiting")),this.$el.append(this.messageElement)):this.messageElement&&(this.messageElement.remove(),this.messageElement=null),e&&n&&!r?this.singleValue.activate().render().appendTo(this.el):this.singleValue&&this.singleValue.deactivate().$el.detach(),this.trigger("rendered",this),this},remove:function(){this.singleValue&&this.singleValue.remove(),this.reportModel&&(this.reportModel._sync&&this.reportModel._sync.destroy(),this.reportModel.off()),this.settings&&(this.settings.off(),this.settings._sync&&this.settings._sync.destroy()),o.prototype.remove.call(this)}});return d}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer('.clearfix{*zoom:1;}.clearfix:before,.clearfix:after{display:table;content:"";line-height:0;}\n.clearfix:after{clear:both;}\n.hide-text{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;border:0;}\n.input-block-level{display:block;width:100%;min-height:26px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;}\n.ie7-force-layout{*min-width:0;}\n.single-value{margin:20px;display:inline-block;*display:inline;*zoom:1;text-align:center;}.single-value .single-result{font-size:24px;font-weight:bold;word-wrap:break-word;}\n.single-value .before-label{margin-right:1em;}\n.single-value .after-label{margin-left:1em;}\n.single-value .under-label{text-transform:uppercase;color:#999999;font-size:11px;}\n.single-value .severe,.single-value.severe .single-result{color:#d85d3c;}\n.single-value .high,.single-value.high .single-result{color:#f7902b;}\n.single-value .elevated,.single-value.elevated .single-result{color:#fac51c;}\n.single-value .guarded,.single-value.guarded .single-result{color:#6ab7c7;}\n.single-value .low,.single-value.low .single-result{color:#65a637;}\n.single-value .None,.single-value.None .single-result{color:#999999;}\n')}),requirejs.s.contexts._.nextTick=requirejs.nextTick;
