define("util/jscharting_utils",["underscore","helpers/user_agent","splunk.util"],function(e,t,n){var r=function(e){return parseInt(e,10)||Infinity},i=/^[^_]|^_time/,s=50,o=function(){var e=n.getConfigValue("JSCHART_TRUNCATION_LIMIT",2e4);return e!==null?r(e):t.isFirefox()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_FIREFOX",2e4)):t.isSafari()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_SAFARI",2e4)):t.isIE11()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_IE11",2e4)):t.isIE10()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_IE10",2e4)):t.isIE9()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_IE9",2e4)):t.isIE8()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_IE8",2e3)):t.isIE7()?r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_IE7",2e3)):r(n.getConfigValue("JSCHART_TRUNCATION_LIMIT_CHROME",2e4))}(),u=function(e,t){t=t||{};var n={};return t.JSCHART_TEST_MODE&&(n.testMode=!0),e.hasField("_tc")&&(n.fieldHideList=["percent"]),n},a=function(t,n){var r={fields:t.fields,columns:[]};return e(t.columns).each(function(e,t){r.columns[t]=e.slice(0,n)}),r},f=function(t){var n=e.isString(t)?t:t.name;return i.test(n)},l=function(t,n){if(t.columns.length===0||t.columns[0].length===0)return t;var r=n.chart||"column";if(r in{pie:!0,scatter:!0,radialGauge:!0,fillerGauge:!0,markerGauge:!0})return t;if(t.fields.length>=s){var i,u=e(t.fields).map(function(t){return e.isString(t)?t:t.name}),l=e(u).indexOf("_span");l>-1&&l>=s&&(i=t.columns[l]),t={columns:t.columns.slice(0,s),fields:t.fields.slice(0,s)},i&&(t.columns.push(i),t.fields.push("_span"))}var c=parseInt(n["chart.resultTruncationLimit"],10)||parseInt(n.resultTruncationLimit,10),h=c>0?c:o,p=e(t.fields).filter(f),d=p.length-1,v=t.columns[0].length,m=Math.floor(h/d);return v>m?a(t,m):t};return{getCustomDisplayProperties:u,preprocessChartData:l}}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("splunkjs/css/jschart.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,define("splunkjs/mvc/chartview",["require","exports","module","underscore","jquery","./mvc","./basesplunkview","./messages","./drilldown","./utils","util/console","splunk.util","splunk.legend","util/jscharting_utils","splunk.config","jquery.ui.resizable","util/general_utils","./tokenawaremodel","uri/route","helpers/Printer","css!../css/jschart"],function(e,t,n){var r=e("underscore"),i=e("jquery"),s=e("./mvc"),o=e("./basesplunkview"),u=e("./messages"),a=e("./drilldown"),f=e("./utils"),l=e("util/console"),c=e("splunk.util"),h=e("splunk.legend"),p=e("util/jscharting_utils"),d=e("splunk.config"),v=e("jquery.ui.resizable"),m,g=e("util/general_utils"),y=e("./tokenawaremodel"),b=e("uri/route"),w=e("helpers/Printer");e("css!../css/jschart");var E=o.extend({moduleId:n.id,className:"splunk-chart",chartOptionPrefix:"charting.",options:{height:"250px",data:"preview",type:"column",drilldownRedirect:!0,"charting.drilldown":"all",resizable:!1},omitFromSettings:["el","reportModel","drilldown"],normalizeOptions:function(e,t){this._normalizeDrilldownType(e,t[t.hasOwnProperty("charting.drilldown")?"charting.drilldown":"drilldown"]),t.hasOwnProperty("charting.layout.splitSeries")&&(g.isBooleanEquivalent(t["charting.layout.splitSeries"])?e.set("charting.layout.splitSeries",g.normalizeBoolean(t["charting.layout.splitSeries"])?"1":"0"):e.set("charting.layout.splitSeries",t["charting.layout.splitSeries"])),t.hasOwnProperty("show")&&e.set("show",c.normalizeBoolean(t.show)?"1":"0"),t.hasOwnProperty("charting.axisY2.enabled")&&(g.isBooleanEquivalent(t["charting.axisY2.enabled"])?e.set("charting.axisY2.enabled",g.normalizeBoolean(t["charting.axisY2.enabled"])?"1":"0"):e.set("charting.axisY2.enabled",t["charting.axisY2.enabled"])),t.hasOwnProperty("charting.legend.labelStyle.overflowMode")&&(t["charting.legend.labelStyle.overflowMode"]==="default"?e.set("charting.legend.labelStyle.overflowMode","ellipsisMiddle"):e.set("charting.legend.labelStyle.overflowMode",t["charting.legend.labelStyle.overflowMode"]))},_normalizeDrilldownType:function(e,t){e.set("charting.drilldown",a.getNormalizedDrilldownType(t,{allowBoolean:!0}))},initialize:function(t){this.configure(),this.model=this.options.reportModel||y._createReportModel(),this.settings._sync=f.syncModels(this.settings,this.model,{auto:!0,prefix:"display.visualizations.",exclude:["managerid","id","name","data","type","drilldownRedirect","height"]}),this.normalizeOptions(this.settings,t),this.settings.on("change:drilldown change:charting.drilldown",this._normalizeDrilldownType,this),this.maxResultCount=1e3,this.settings.has("charting.data.count")&&!r.isNaN(parseInt(this.settings.get("charting.data.count"),10))&&(this.maxResultCount=parseInt(this.settings.get("charting.data.count"),10)),this._currentHeight=parseInt(this.settings.get("height"),10),this.$chart=i("<div></div>"),this.$msg=i("<div></div>"),this.$inlineMsg=i("<div></div>"),this.settings.on("change",this.render,this);var n=this;e(["js_charting/js_charting"],function(e){m=e,n._chartCreationPending&&n.chartData&&n._createChart(),n.createChart=n._createChart}),this.bindToComponentSetting("managerid",this._onManagerChange,this),h.register(this.cid),this._onResizeMouseup=r.bind(this._onResizeMouseup,this),this.settings.on("change:resizable",function(e,t,n){t?this._enableResize():this._disableResize()},this),this.settings.get("resizable")&&this._enableResize(),this.settings.on("change:height",this._onChartHeightChange,this),this.listenTo(w,w.PRINT_START,this.resizeChart),this.listenTo(w,w.PRINT_END,this.resizeChart),this.manager||this._onManagerChange(s.Components,null)},_onManagerChange:function(e,t){this.manager&&(this.manager.off(null,null,this),this.manager=null),this.resultsModel&&(this.resultsModel.off(null,null,this),this.resultsModel=null);if(!t){this.message("no-search");return}this.message("empty"),this._err=!1,this.manager=t,this.resultsModel=this.manager.data(this.settings.get("data"),{autofetch:!0,output_mode:"json_cols",show_metadata:!0,count:this.maxResultCount}),this.resultsModel.on("data",this._onDataChanged,this),this.resultsModel.on("error",this._onSearchError,this),t.on("search:start",this._onSearchStart,this),t.on("search:progress",this._onSearchProgress,this),t.on("search:done",this._onSearchProgress,this),t.on("search:cancelled",this._onSearchCancelled,this),t.on("search:refresh",this._onSearchRefresh,this),t.on("search:fail",this._onSearchFailed,this),t.on("search:error",this._onSearchError,this),t.replayLastSearchEvent(this)},_onDataChanged:function(){if(!this.resultsModel.hasData()){this._isJobDone&&this.message("no-results");return}var e=this.resultsModel.data();l.log("chart data changed:",e),e.fields.length&&(this.chartData=e,this.updateChart())},_onSearchProgress:function(e){this._err=!1,e=e||{};var t=e.content||{},n=t.resultPreviewCount||0,r=this._isJobDone=t.isDone||!1;if(n===0&&r){this.message("no-results");return}n===0&&this.message("waiting")},_onSearchCancelled:function(){this._isJobDone=!1,this.message("cancelled")},_onSearchRefresh:function(){this._isJobDone=!1,this.message("refresh")},_onSearchError:function(e,t){this._isJobDone=!1,this._err=!0;var n=u.getSearchErrorMessage(t)||e;this.message({level:"error",icon:"warning-sign",message:n})},_onSearchFailed:function(e){this._isJobDone=!1,this._err=!0;var t=u.getSearchFailureMessage(e);this.message({level:"error",icon:"warning-sign",message:t})},_onSearchStart:function(){this._isJobDone=!1,this._err=!1,this.destroyChart(),this.message("waiting")},message:function(e){this.$msg.detach(),u.render(e,this.$msg),this.$msg.prependTo(this.$el)},inlineMessage:function(e){e.compact=!0,u.render(e,this.$inlineMsg)},render:function(){return this.$el.height(this._currentHeight).css("overflow","hidden"),this.$msg.height(this._currentHeight).css("overflow","hidden"),this.$chart.appendTo(this.$el),this.$inlineMsg.appendTo(this.$el),this.chart&&this.destroyChart(),this._boundInvalidateChart||(this._boundInvalidateChart=r.bind(this.invalidateChart,this)),h.removeEventListener("labelIndexMapChanged",this._boundInvalidateChart),h.addEventListener("labelIndexMapChanged",this._boundInvalidateChart),this._debouncedResize||(this._debouncedResize=r.debounce(r.bind(this.resizeChart,this),100)),i(window).off("resize",this._debouncedResize),i(window).on("resize",this._debouncedResize),this.createChart(),this},show:function(){this.$el.css("display","")},hide:function(){this.$el.css("display","none")},createChart:function(){this._chartCreationPending=!0},_enableResize:function(){this._canEnableResize()&&(this.$el.resizable({autoHide:!0,handles:"s",stop:this._onResizeStop.bind(this)}),this.$el.on("mouseup",this._onResizeMouseup))},_disableResize:function(){this._canEnableResize()&&(this.$el.resizable("destroy"),this.$el.off("mouseup",this._onResizeMouseup))},_onResizeMouseup:function(e){i(this).width("100%")},_onResizeStop:function(e,t){i(e.target).width("100%"),this._currentHeight=this.$el.height(),this.settings.set("height",this._currentHeight),this.resizeChart()},_canEnableResize:function(){return!0},_createChart:function(){var e={chart:this.settings.get("type")},t=this.chartOptionPrefix;r.each(this.settings.toJSON(),function(n,r){r.substring(0,t.length)==t&&(e[r.substring(t.length)]=n)},this);if(this._err)return;this.$msg.detach(),l.log("Creating chart with data: ",e);var n=this.chart=m.createChart(this.$chart,e);n.on("pointClick",this.emitDrilldownEvent.bind(this)),n.on("legendClick",this.emitDrilldownEvent.bind(this)),n.on("chartRangeSelect",this.emitSelectionEvent.bind(this)),this.updateChart()},_onChartHeightChange:function(){this._currentHeight=parseInt(this.settings.get("height"),10),this.resizeChart()},resizeChart:function(){this.chart&&(this.updateChartContainerHeight(),this.chart.resize())},updateChart:function(){if(this._err)return;l.log("updateChart data=%o this.chart=%o",this.chartData,this.chart);if(this.chartData)if(this.chart){this.$msg.detach(),this.$inlineMsg.empty();var e=p.preprocessChartData(this.chartData,this.chart.getCurrentDisplayProperties()),t=m.extractChartReadyData(e);this.chart.prepare(t,p.getCustomDisplayProperties(t,d));if(e.columns.length>0&&(e.columns.length<this.chartData.columns.length||e.columns[0].length<this.chartData.columns[0].length)){var n="These results may be truncated. Your search generated too much data for the current visualization configuration.",i=r(n).t(),s=f.getPageInfo(),o=b.docHelp(s.root,s.locale,"learnmore.charting.datatruncation"),u=' <a href="<%- href %>" target="_blank"><span><%- text %></span><i class="icon-external icon-no-underline"></i></a>';i+=r(u).template({href:o,text:r("Learn More").t()}),this.inlineMessage({level:"warn",message:i})}else this.chartData.columns.length>0&&this.maxResultCount>0&&this.chartData.columns[0].length>=this.maxResultCount&&this.inlineMessage({level:"warn",message:c.sprintf(r("These results may be truncated. This visualization is configured to display a maximum of %s results per series, and that limit has been reached.").t(),this.maxResultCount)});this.updateChartContainerHeight();if(this.chart.requiresExternalColorPalette()){var a=this.chart.getFieldList();h.setLabels(this.cid,a)}this.invalidateChart()}else this.createChart()},destroyChart:function(){this.chart&&(this.chart.off(),this.chart.destroy(),this.chart=null,clearTimeout(this._redrawChartTimeout))},updateChartContainerHeight:function(){this.$chart.height(this._currentHeight-this.$inlineMsg.outerHeight())},invalidateChart:function(){clearTimeout(this._redrawChartTimeout);if(!this.chart||!this.chartData)return;var e=this;this._redrawChartTimeout=setTimeout(function(){e.chart.requiresExternalColorPalette()&&e.setChartColorPalette();var t=(new Date).getTime();e.chart.draw().done(function(){l.DEBUG_ENABLED&&l.log("Chart=%o drawn in duration=%o ms",e.model.get("display.visualizations.charting.chart"),(new Date).getTime()-t),e.trigger("rendered",e),e.model.set({currentChartFields:e.chart.getFieldList()})})},5)},setChartColorPalette:function(){var e={};r(this.chart.getFieldList()).each(function(t){e[t]=h.getLabelIndex(t)}),this.chart.setExternalColorPalette(e,h.numLabels())},emitDrilldownEvent:function(e){var t=this.manager,n=a.getNormalizedDrilldownType(this.settings.get("charting.drilldown"),{allowBoolean:!0}),i=a.createEventPayload({field:e.name2||e.name,data:a.normalizeDrilldownEventData(e,{manager:t,contextProperty:"rowContext"}),event:e},function(){a.autoDrilldown(e,t,{drilldownType:n==="all"?"all":"none"})});this.trigger("drilldown click",i,this),this.trigger(e.type==="legendClick"?"clicked:legend click:legend":"clicked:chart click:chart",r.extend({},e,{preventDefault:i.preventDefault,drilldown:i.drilldown}),this),n==="all"&&this.settings.get("drilldownRedirect")&&!i.defaultPrevented()&&i.drilldown()},emitSelectionEvent:function(e){var t={start:e.startXValue,end:e.endXValue},n=this.resultsModel.data();r(n.fields).each(function(r,i){t["start."+r.name]=n.columns[i][e.startXIndex],t["end."+r.name]=n.columns[i][e.endXIndex]});var i={data:t,preventDefault:function(){e.preventDefault()},results:n,selection:function(){var t=[];for(var i=e.startXIndex;i<=e.endXIndex;i++)t.push(r(n.columns).pluck(i));var s=r(n.fields).pluck("name");return r(t).map(function(e){return r.object(s,e)})},startIndex:e.startXIndex,endIndex:e.endXIndex,startValue:e.startXValue,endValue:e.endXValue,isReset:e.isReset,event:e};this.trigger("selection",i,this)},remove:function(){h.unregister(this.cid),this._boundInvalidateChart&&h.removeEventListener("labelIndexMapChanged",this._boundInvalidateChart),this._debouncedResize&&i(window).off("resize",this._debouncedResize),this.chart&&this.destroyChart(),this.settings&&(this.settings.off(),this.settings._sync&&this.settings._sync.destroy()),o.prototype.remove.call(this)}});return E}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer('.clearfix{*zoom:1;}.clearfix:before,.clearfix:after{display:table;content:"";line-height:0;}\n.clearfix:after{clear:both;}\n.hide-text{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;border:0;}\n.input-block-level{display:block;width:100%;min-height:26px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;}\n.ie7-force-layout{*min-width:0;}\n.btn-pan-left,.btn-pan-right{background:#525252;background:rgba(0, 0, 0, 0.32);position:absolute;z-index:9999;padding:4px 5px;color:#FFFFFF;line-height:10px;-webkit-border-radius:1px;-moz-border-radius:1px;border-radius:1px;}.btn-pan-left:hover,.btn-pan-right:hover,.btn-pan-left.active,.btn-pan-right.active{background:#454545;background:rgba(0, 0, 0, 0.27);text-decoration:none;color:#FFFFFF;-webkit-border-radius:1px;-moz-border-radius:1px;border-radius:1px;}\n.btn-zoom-out,.btn-reset-selection{position:absolute;z-index:9999;}\n.btn-reset-selection{margin-top:5px;margin-right:10px;}\n')}),requirejs.s.contexts._.nextTick=requirejs.nextTick;
